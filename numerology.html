<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Numerology Reading</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Google Fonts: Inter -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <!-- Font Awesome for icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        .animate-spin-slow {
            animation: spin 3s linear infinite;
        }
        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="bg-gradient-to-br from-indigo-500 via-purple-500 to-pink-500 flex items-center justify-center min-h-screen p-4">

    <!-- Main Container -->
    <div class="bg-white bg-opacity-90 backdrop-blur-lg rounded-3xl shadow-2xl p-8 max-w-3xl w-full mx-auto transform transition-all duration-500 ease-in-out">
        
        <h1 class="text-4xl md:text-5xl font-bold text-center text-purple-800 mb-6 drop-shadow-md">Your Numerology Reading</h1>
        <p class="text-center text-gray-600 mb-8">Discover the deeper meaning behind your name and date of birth.</p>

        <!-- Form for user input -->
        <form id="numerology-form" class="space-y-8">
            <!-- User's Information -->
            <div class="bg-purple-50 p-6 rounded-2xl border border-purple-200">
                <h2 class="text-2xl font-bold text-purple-700 mb-4">Your Information</h2>
                <div class="space-y-4">
                    <div>
                        <label for="name" class="block text-sm font-medium text-gray-700">Your Full Name</label>
                        <input type="text" id="name" class="mt-1 block w-full rounded-full border-gray-300 shadow-sm p-3 focus:ring-purple-500 focus:border-purple-500 transition duration-300" placeholder="e.g., Jane Doe">
                    </div>
                    <div>
                        <label for="dob" class="block text-sm font-medium text-gray-700">Date of Birth</label>
                        <input type="date" id="dob" class="mt-1 block w-full rounded-full border-gray-300 shadow-sm p-3 focus:ring-purple-500 focus:border-purple-500 transition duration-300">
                    </div>
                </div>
            </div>

            <!-- Partner's Information -->
            <div class="bg-pink-50 p-6 rounded-2xl border border-pink-200">
                <h2 class="text-2xl font-bold text-pink-700 mb-4">Partner's Information (Optional)</h2>
                <div class="space-y-4">
                    <div>
                        <label for="partner-name" class="block text-sm font-medium text-gray-700">Partner's Full Name</label>
                        <input type="text" id="partner-name" class="mt-1 block w-full rounded-full border-gray-300 shadow-sm p-3 focus:ring-pink-500 focus:border-pink-500 transition duration-300" placeholder="e.g., John Smith">
                    </div>
                    <div>
                        <label for="partner-dob" class="block text-sm font-medium text-gray-700">Partner's Date of Birth</label>
                        <input type="date" id="partner-dob" class="mt-1 block w-full rounded-full border-gray-300 shadow-sm p-3 focus:ring-pink-500 focus:border-pink-500 transition duration-300">
                    </div>
                </div>
            </div>

            <button type="submit" id="submit-btn" class="w-full bg-purple-600 text-white font-bold py-3 px-4 rounded-full shadow-lg hover:bg-purple-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-purple-500 transition duration-300 ease-in-out transform hover:scale-105">
                Get My Comprehensive Reading
            </button>
        </form>

        <!-- Loading state -->
        <div id="loading" class="hidden text-center mt-8">
            <div class="flex flex-col items-center">
                <i class="fas fa-spinner fa-spin text-purple-600 text-4xl mb-4 animate-spin-slow"></i>
                <p class="text-gray-600 font-semibold text-lg">Generating your complete reading, please wait...</p>
            </div>
        </div>

        <!-- Result display section -->
        <div id="result" class="hidden mt-8">
            <div class="bg-purple-50 p-6 rounded-2xl shadow-inner border border-purple-200">
                <h2 id="result-title" class="text-3xl font-bold text-purple-700 mb-2"></h2>
                <p id="result-summary" class="text-gray-800 text-lg mb-4"></p>
                
                <!-- Your Numbers -->
                <div id="main-numbers-section" class="mb-6">
                    <p class="text-xl font-semibold text-purple-600">Your Core Numbers</p>
                    <div class="flex flex-wrap gap-2">
                        <span class="inline-block bg-purple-200 text-purple-800 text-sm font-semibold px-3 py-1 rounded-full">
                            Life Path: <span id="life-path-number" class="font-bold ml-1"></span>
                        </span>
                        <span class="inline-block bg-purple-200 text-purple-800 text-sm font-semibold px-3 py-1 rounded-full">
                            Expression: <span id="expression-number" class="font-bold ml-1"></span>
                        </span>
                        <span class="inline-block bg-purple-200 text-purple-800 text-sm font-semibold px-3 py-1 rounded-full">
                            Soul Urge: <span id="soul-urge-number" class="font-bold ml-1"></span>
                        </span>
                    </div>
                </div>
                
                <!-- Partner's Numbers (conditional display) -->
                <div id="partner-numbers-section" class="mb-6 hidden">
                    <p class="text-xl font-semibold text-pink-600">Partner's Core Numbers</p>
                    <div class="flex flex-wrap gap-2">
                        <span class="inline-block bg-pink-200 text-pink-800 text-sm font-semibold px-3 py-1 rounded-full">
                            Life Path: <span id="partner-life-path-number" class="font-bold ml-1"></span>
                        </span>
                        <span class="inline-block bg-pink-200 text-pink-800 text-sm font-semibold px-3 py-1 rounded-full">
                            Expression: <span id="partner-expression-number" class="font-bold ml-1"></span>
                        </span>
                        <span class="inline-block bg-pink-200 text-pink-800 text-sm font-semibold px-3 py-1 rounded-full">
                            Soul Urge: <span id="partner-soul-urge-number" class="font-bold ml-1"></span>
                        </span>
                    </div>
                </div>
                
                <!-- Main Reading Section -->
                <div id="main-reading-content" class="bg-white p-4 rounded-xl shadow-md mb-4">
                    <h3 id="main-reading-title" class="text-2xl font-semibold text-purple-700 mb-2"></h3>
                    <p id="result-description" class="text-gray-600 mb-6"></p>
                </div>

                <!-- Compatibility Reading Section (conditional display) -->
                <div id="compatibility-section" class="hidden bg-pink-100 p-4 rounded-xl shadow-md mb-6">
                    <h3 id="compatibility-title" class="text-2xl font-semibold text-pink-700 mb-2"></h3>
                    <p id="compatibility-description" class="text-gray-600"></p>
                </div>
                
                <!-- Personal Cycle Reading Section -->
                <div id="personal-cycle-reading-content" class="bg-indigo-100 p-4 rounded-xl shadow-md mb-6">
                    <h3 class="text-2xl font-semibold text-indigo-700 mb-2">Your Personal Cycles</h3>
                    <div class="space-y-4">
                        <div id="yearly-cycle-card" class="bg-white p-4 rounded-xl shadow-sm border-l-4 border-indigo-500">
                            <p class="text-xl font-semibold text-indigo-600">Personal Year: <span id="yearly-number" class="font-bold"></span></p>
                            <p id="yearly-description" class="text-gray-600 mt-2"></p>
                        </div>
                        <div id="monthly-cycle-card" class="bg-white p-4 rounded-xl shadow-sm border-l-4 border-indigo-500">
                            <p class="text-xl font-semibold text-indigo-600">Personal Month: <span id="monthly-number" class="font-bold"></span></p>
                            <p id="monthly-description" class="text-gray-600 mt-2"></p>
                        </div>
                        <div id="daily-cycle-card" class="bg-white p-4 rounded-xl shadow-sm border-l-4 border-indigo-500">
                            <p class="text-xl font-semibold text-indigo-600">Personal Day: <span id="daily-number" class="font-bold"></span></p>
                            <p id="daily-description" class="text-gray-600 mt-2"></p>
                        </div>
                    </div>
                </div>

                <!-- Pinnacle Reading Section -->
                <div id="pinnacle-reading-content" class="bg-yellow-100 p-4 rounded-xl shadow-md mb-6">
                    <h3 id="pinnacle-reading-title" class="text-2xl font-semibold text-yellow-700 mb-2"></h3>
                    <div id="pinnacle-readings-container" class="grid md:grid-cols-2 gap-4 mt-4">
                        <!-- Pinnacle cards will be dynamically added here -->
                    </div>
                </div>

                <!-- Challenge Reading Section -->
                <div id="challenge-reading-content" class="bg-red-100 p-4 rounded-xl shadow-md mb-6">
                    <h3 class="text-2xl font-semibold text-red-700 mb-2">Your Challenge Numbers</h3>
                    <p id="challenge-reading-intro" class="text-gray-600 mb-4"></p>
                    <div id="challenge-readings-container" class="grid md:grid-cols-3 gap-4 mt-4">
                        <!-- Challenge cards will be dynamically added here -->
                    </div>
                </div>
                
                <div class="mt-6 flex flex-col sm:flex-row gap-4">
                    <button id="listen-btn" class="flex-1 flex items-center justify-center bg-purple-600 text-white font-bold py-3 px-4 rounded-full shadow-lg hover:bg-purple-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-purple-500 transition duration-300 ease-in-out transform hover:scale-105">
                        <i class="fas fa-play mr-2"></i> Listen to Reading
                    </button>
                    <button id="reset-btn" class="flex-1 flex items-center justify-center bg-gray-200 text-gray-800 font-bold py-3 px-4 rounded-full shadow-lg hover:bg-gray-300 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-gray-400 transition duration-300 ease-in-out transform hover:scale-105">
                        <i class="fas fa-redo mr-2"></i> New Reading
                    </button>
                </div>
                <div id="audio-container" class="mt-4 hidden">
                    <audio id="audio-player" controls class="w-full"></audio>
                </div>
            </div>
        </div>

        <!-- Custom modal for error messages -->
        <div id="error-modal" class="hidden fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-50">
            <div class="relative top-20 mx-auto p-5 border w-96 shadow-lg rounded-md bg-white">
                <div class="mt-3 text-center">
                    <div class="mx-auto flex items-center justify-center h-12 w-12 rounded-full bg-red-100">
                        <i class="fas fa-exclamation-triangle text-red-600 text-xl"></i>
                    </div>
                    <h3 class="text-lg leading-6 font-medium text-gray-900 mt-2">Error</h3>
                    <div class="mt-2 px-7 py-3">
                        <p id="error-message" class="text-sm text-gray-500"></p>
                    </div>
                    <div class="items-center px-4 py-3">
                        <button id="close-error-modal" class="px-4 py-2 bg-red-500 text-white text-base font-medium rounded-full w-full shadow-sm hover:bg-red-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-red-500 transition duration-300">
                            Close
                        </button>
                    </div>
                </div>
            </div>
        </div>

    </div>

    <script>
        // Define global variables for Firebase configuration and app ID.
        // These are provided by the canvas environment.
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};

        // Helper function to show a custom error modal
        function showError(message) {
            const errorModal = document.getElementById('error-modal');
            const errorMessage = document.getElementById('error-message');
            errorMessage.textContent = message;
            errorModal.classList.remove('hidden');
        }

        // Helper function to close the error modal
        document.getElementById('close-error-modal').addEventListener('click', () => {
            document.getElementById('error-modal').classList.add('hidden');
        });

        // Function to reduce a number to a single digit or a master number (11, 22, 33)
        const reduceNumber = (num) => {
            const masterNumbers = [11, 22, 33];
            let sum = num;
            while (sum > 9 && !masterNumbers.includes(sum)) {
                sum = sum.toString().split('').reduce((acc, digit) => acc + parseInt(digit, 10), 0);
            }
            return sum;
        };
        
        // Function to check for Karmic Debt or Master numbers from a sum
        const checkSpecialNumber = (initialSum) => {
            const karmicDebts = [13, 14, 16, 19];
            const masterNumbers = [11, 22, 33];
            
            if (masterNumbers.includes(initialSum)) {
                return `Master Number ${initialSum}`;
            }
            if (karmicDebts.includes(initialSum)) {
                return `Karmic Debt Number ${initialSum}`;
            }
            return null;
        };

        // Function to calculate the Life Path Number and check for special numbers
        const calculateLifePathNumber = (dobString) => {
            if (!dobString) return { number: null, special: null };
            const [year, month, day] = dobString.split('-').map(Number);
            const monthSum = month;
            const daySum = day;
            const yearSum = year;
            const lifePathSum = reduceNumber(monthSum) + reduceNumber(daySum) + reduceNumber(yearSum);
            return {
                number: reduceNumber(lifePathSum),
                special: checkSpecialNumber(lifePathSum)
            };
        };
        
        // Map of letters to their numerological values
        const letterToNumberMap = {
            'A': 1, 'J': 1, 'S': 1,
            'B': 2, 'K': 2, 'T': 2,
            'C': 3, 'L': 3, 'U': 3,
            'D': 4, 'M': 4, 'V': 4,
            'E': 5, 'N': 5, 'W': 5,
            'F': 6, 'O': 6, 'X': 6,
            'G': 7, 'P': 7, 'Y': 7,
            'H': 8, 'Q': 8, 'Z': 8,
            'I': 9, 'R': 9
        };

        // Function to calculate the Expression Number and check for special numbers
        const calculateExpressionNumber = (name) => {
            if (!name) return { number: null, special: null };
            let sum = 0;
            const cleanName = name.toUpperCase().replace(/[^A-Z]/g, '');
            for (const letter of cleanName) {
                sum += letterToNumberMap[letter] || 0;
            }
            return {
                number: reduceNumber(sum),
                special: checkSpecialNumber(sum)
            };
        };

        // Function to calculate the Soul Urge Number and check for special numbers
        const calculateSoulUrgeNumber = (name) => {
            if (!name) return { number: null, special: null };
            let sum = 0;
            const vowels = ['A', 'E', 'I', 'O', 'U'];
            const cleanName = name.toUpperCase().replace(/[^A-Z]/g, '');
            for (const letter of cleanName) {
                if (vowels.includes(letter)) {
                    sum += letterToNumberMap[letter] || 0;
                }
                // 'Y' is sometimes a vowel, but for simplicity we will treat it as a consonant here.
            }
            return {
                number: reduceNumber(sum),
                special: checkSpecialNumber(sum)
            };
        };
        
        // Function to calculate the four Pinnacle numbers and their age ranges
        const calculatePinnacleNumbers = (dobString) => {
            if (!dobString) return null;
            const [year, month, day] = dobString.split('-').map(Number);
            
            const monthSum = reduceNumber(month);
            const daySum = reduceNumber(day);
            const yearSum = reduceNumber(year);
            const lifePathNumber = calculateLifePathNumber(dobString).number;
            
            const pinnacle1 = reduceNumber(monthSum + daySum);
            const pinnacle2 = reduceNumber(daySum + yearSum);
            const pinnacle3 = reduceNumber(pinnacle1 + pinnacle2);
            const pinnacle4 = reduceNumber(monthSum + yearSum);
            
            const age1 = 36 - lifePathNumber;
            const age2 = age1 + 9;
            const age3 = age2 + 9;
            
            return [
                { number: pinnacle1, age_range: `Birth to ${age1}` },
                { number: pinnacle2, age_range: `${age1 + 1} to ${age2}` },
                { number: pinnacle3, age_range: `${age2 + 1} to ${age3}` },
                { number: pinnacle4, age_range: `${age3 + 1} onwards` }
            ];
        };
        
        // Function to calculate the three Challenge numbers
        const calculateChallengeNumbers = (dobString) => {
            if (!dobString) return null;
            const [year, month, day] = dobString.split('-').map(Number);
            
            const monthSum = reduceNumber(month);
            const daySum = reduceNumber(day);
            const yearSum = reduceNumber(year);
            
            const challenge1 = Math.abs(monthSum - daySum);
            const challenge2 = Math.abs(daySum - yearSum);
            const challenge3 = Math.abs(challenge1 - challenge2);
            
            return [
                { number: reduceNumber(challenge1), description: "First Challenge" },
                { number: reduceNumber(challenge2), description: "Second Challenge" },
                { number: reduceNumber(challenge3), description: "Third Challenge" }
            ];
        };
        
        // Function to calculate the Personal Cycle numbers (Year, Month, Day)
        const calculatePersonalCycleNumbers = (dobString) => {
            if (!dobString) return null;
            const today = new Date();
            const todayMonth = today.getMonth() + 1;
            const todayDay = today.getDate();
            const todayYear = today.getFullYear();
            const [dobYear, dobMonth, dobDay] = dobString.split('-').map(Number);
            
            const dobMonthDaySum = reduceNumber(dobMonth) + reduceNumber(dobDay);
            const personalYearSum = reduceNumber(dobMonthDaySum) + reduceNumber(todayYear);
            const personalMonthSum = reduceNumber(personalYearSum) + reduceNumber(todayMonth);
            const personalDaySum = reduceNumber(personalMonthSum) + reduceNumber(todayDay);

            return {
                yearly: reduceNumber(personalYearSum),
                monthly: reduceNumber(personalMonthSum),
                daily: reduceNumber(personalDaySum)
            };
        };

        // Base64 to ArrayBuffer helper function
        function base64ToArrayBuffer(base64) {
            const binaryString = atob(base64);
            const len = binaryString.length;
            const bytes = new Uint8Array(len);
            for (let i = 0; i < len; i++) {
                bytes[i] = binaryString.charCodeAt(i);
            }
            return bytes.buffer;
        }

        // PCM to WAV converter helper function
        function pcmToWav(pcm16, sampleRate) {
            const numChannels = 1;
            const bytesPerSample = 2;
            const dataLength = pcm16.length * bytesPerSample;
            const buffer = new ArrayBuffer(44 + dataLength);
            const view = new DataView(buffer);
            const writeString = (str) => {
                for (let i = 0; i < str.length; i++) {
                    view.setUint8(view.byteOffset + i, str.charCodeAt(i));
                }
            };
            let offset = 0;

            // RIFF header
            writeString('RIFF'); offset += 4;
            view.setUint32(offset, 36 + dataLength, true); offset += 4;
            writeString('WAVE'); offset += 4;

            // FMT sub-chunk
            writeString('fmt '); offset += 4;
            view.setUint32(offset, 16, true); offset += 4;
            view.setUint16(offset, 1, true); offset += 2; // PCM
            view.setUint16(offset, numChannels, true); offset += 2;
            view.setUint32(offset, sampleRate, true); offset += 4;
            view.setUint32(offset, sampleRate * numChannels * bytesPerSample, true); offset += 4;
            view.setUint16(offset, numChannels * bytesPerSample, true); offset += 2;
            view.setUint16(offset, 16, true); offset += 2; // 16-bit PCM

            // DATA sub-chunk
            writeString('data'); offset += 4;
            view.setUint32(offset, dataLength, true); offset += 4;

            for (let i = 0; i < pcm16.length; i++) {
                view.setInt16(offset, pcm16[i], true);
                offset += 2;
            }

            return new Blob([buffer], { type: 'audio/wav' });
        }


        // Function to play audio from the TTS API
        async function playAudio(text) {
            const listenBtn = document.getElementById('listen-btn');
            const audioPlayer = document.getElementById('audio-player');
            const audioContainer = document.getElementById('audio-container');

            listenBtn.innerHTML = `<i class="fas fa-spinner fa-spin mr-2"></i> Loading Audio...`;
            listenBtn.disabled = true;

            const payload = {
                contents: [{
                    parts: [{ text: `Say in a smooth, informative tone: ${text}` }]
                }],
                generationConfig: {
                    responseModalities: ["AUDIO"],
                    speechConfig: {
                        voiceConfig: {
                            prebuiltVoiceConfig: { voiceName: "Kore" }
                        }
                    }
                },
                model: "gemini-2.5-flash-preview-tts"
            };

            const apiKey = "";
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-tts:generateContent?key=${apiKey}`;

            try {
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                const result = await response.json();
                
                const part = result?.candidates?.[0]?.content?.parts?.[0];
                const audioData = part?.inlineData?.data;
                const mimeType = part?.inlineData?.mimeType;

                if (audioData && mimeType && mimeType.startsWith("audio/L16")) {
                    const sampleRateMatch = mimeType.match(/rate=(\d+)/);
                    if (sampleRateMatch) {
                        const sampleRate = parseInt(sampleRateMatch[1], 10);
                        const pcmData = base64ToArrayBuffer(audioData);
                        const pcm16 = new Int16Array(pcmData);
                        const wavBlob = pcmToWav(pcm16, sampleRate);
                        const audioUrl = URL.createObjectURL(wavBlob);
                        
                        audioPlayer.src = audioUrl;
                        audioContainer.classList.remove('hidden');
                        audioPlayer.play();
                    } else {
                        throw new Error("Could not parse audio sample rate from MIME type.");
                    }
                } else {
                    throw new Error("Invalid audio data received from API.");
                }
            } catch (error) {
                console.error("Error generating or playing audio:", error);
                showError("Failed to generate audio reading. Please try again.");
            } finally {
                listenBtn.innerHTML = `<i class="fas fa-play mr-2"></i> Listen to Reading`;
                listenBtn.disabled = false;
            }
        }

        // Main Numerology Reading Function
        async function getComprehensiveReading(name, dob, partnerName, partnerDob) {
            const form = document.getElementById('numerology-form');
            const loading = document.getElementById('loading');
            const resultDiv = document.getElementById('result');
            
            form.classList.add('hidden');
            loading.classList.remove('hidden');
            resultDiv.classList.add('hidden');

            try {
                const userLifePath = calculateLifePathNumber(dob);
                const userExpression = calculateExpressionNumber(name);
                const userSoulUrge = calculateSoulUrgeNumber(name);
                const userPinnacles = calculatePinnacleNumbers(dob);
                const userChallenges = calculateChallengeNumbers(dob);
                const userCycles = calculatePersonalCycleNumbers(dob);
                
                let partnerLifePath = { number: null, special: null };
                let partnerExpression = { number: null, special: null };
                let partnerSoulUrge = { number: null, special: null };
                let hasPartner = false;
                
                if (partnerName && partnerDob) {
                    partnerLifePath = calculateLifePathNumber(partnerDob);
                    partnerExpression = calculateExpressionNumber(partnerName);
                    partnerSoulUrge = calculateSoulUrgeNumber(partnerName);
                    hasPartner = true;
                }
                
                const prompt = `You are a numerology expert. Provide a comprehensive numerology reading for a person named ${name}, born on ${dob}. The reading should cover the following in a single, detailed JSON response:
1.  **Core Numbers:** The significance of their Life Path, Expression, and Soul Urge numbers.
2.  **Pinnacle of Glory ('Đỉnh Cao Danh Vọng'):** A deep analysis of their four pinnacles, with the numbers ${userPinnacles[0].number}, ${userPinnacles[1].number}, ${userPinnacles[2].number}, and ${userPinnacles[3].number}.
3.  **Challenge Numbers:** Explain the three challenge numbers, which are ${userChallenges[0].number}, ${userChallenges[1].number}, and ${userChallenges[2].number}.
4.  **Personal Cycles:** Interpret their current Personal Year (${userCycles.yearly}), Personal Month (${userCycles.monthly}), and Personal Day (${userCycles.daily}) numbers.
${hasPartner ? `5. **Compatibility:** Provide a compatibility reading between ${name} (Life Path ${userLifePath.number}) and their partner ${partnerName} (Life Path ${partnerLifePath.number}).` : ''}

The response should be a single JSON object with the following schema:
{
    "summary": "string",
    "main_reading_title": "string",
    "core_number_description": "string",
    "compatibility": {
        "title": "string",
        "description": "string"
    },
    "pinnacles_title": "string",
    "pinnacles": [
        {"pinnacle_number": number, "age_range": "string", "pinnacle_title": "string", "description": "string"}
    ],
    "challenges_title": "string",
    "challenges_intro": "string",
    "challenges": [
        {"challenge_number": number, "description": "string"}
    ],
    "cycles_title": "string",
    "yearly_description": "string",
    "monthly_description": "string",
    "daily_description": "string"
}
`;

                const chatHistory = [{ role: "user", parts: [{ text: prompt }] }];
                const payload = {
                    contents: chatHistory,
                    generationConfig: {
                        responseMimeType: "application/json",
                        responseSchema: {
                            type: "OBJECT",
                            properties: {
                                "summary": { "type": "STRING" },
                                "main_reading_title": { "type": "STRING" },
                                "core_number_description": { "type": "STRING" },
                                "compatibility": {
                                    "type": "OBJECT",
                                    "properties": {
                                        "title": { "type": "STRING" },
                                        "description": { "type": "STRING" }
                                    }
                                },
                                "pinnacles_title": { "type": "STRING" },
                                "pinnacles": {
                                    "type": "ARRAY",
                                    "items": {
                                        "type": "OBJECT",
                                        "properties": {
                                            "pinnacle_number": { "type": "NUMBER" },
                                            "age_range": { "type": "STRING" },
                                            "pinnacle_title": { "type": "STRING" },
                                            "description": { "type": "STRING" }
                                        }
                                    }
                                },
                                "challenges_title": { "type": "STRING" },
                                "challenges_intro": { "type": "STRING" },
                                "challenges": {
                                    "type": "ARRAY",
                                    "items": {
                                        "type": "OBJECT",
                                        "properties": {
                                            "challenge_number": { "type": "NUMBER" },
                                            "description": { "type": "STRING" }
                                        }
                                    }
                                },
                                "cycles_title": { "type": "STRING" },
                                "yearly_description": { "type": "STRING" },
                                "monthly_description": { "type": "STRING" },
                                "daily_description": { "type": "STRING" }
                            }
                        }
                    }
                };
                
                const apiKey = "";
                const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`;

                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                
                const result = await response.json();
                
                if (result.candidates && result.candidates.length > 0 &&
                    result.candidates[0].content && result.candidates[0].content.parts &&
                    result.candidates[0].content.parts.length > 0) {
                    const jsonString = result.candidates[0].content.parts[0].text;
                    const numerologyData = JSON.parse(jsonString);

                    // Show all sections
                    document.getElementById('main-numbers-section').classList.remove('hidden');
                    document.getElementById('main-reading-content').classList.remove('hidden');
                    document.getElementById('personal-cycle-reading-content').classList.remove('hidden');
                    document.getElementById('pinnacle-reading-content').classList.remove('hidden');
                    document.getElementById('challenge-reading-content').classList.remove('hidden');
                    document.getElementById('compatibility-section').classList.add('hidden'); // default hidden

                    // Populate core numbers
                    document.getElementById('life-path-number').textContent = userLifePath.number;
                    document.getElementById('expression-number').textContent = userExpression.number;
                    document.getElementById('soul-urge-number').textContent = userSoulUrge.number;

                    // Populate main reading
                    document.getElementById('result-title').textContent = numerologyData.main_reading_title || "Your Complete Numerology Profile";
                    document.getElementById('result-summary').textContent = numerologyData.summary || "No summary provided.";
                    document.getElementById('result-description').textContent = numerologyData.core_number_description || "No description provided.";
                    
                    // Handle partner display and compatibility
                    if (hasPartner) {
                        document.getElementById('partner-numbers-section').classList.remove('hidden');
                        document.getElementById('partner-life-path-number').textContent = partnerLifePath.number;
                        document.getElementById('partner-expression-number').textContent = partnerExpression.number;
                        document.getElementById('partner-soul-urge-number').textContent = partnerSoulUrge.number;
                        document.getElementById('compatibility-section').classList.remove('hidden');
                        document.getElementById('compatibility-title').textContent = numerologyData.compatibility.title || "Compatibility Reading";
                        document.getElementById('compatibility-description').textContent = numerologyData.compatibility.description || "No compatibility reading provided.";
                    } else {
                        document.getElementById('partner-numbers-section').classList.add('hidden');
                        document.getElementById('compatibility-section').classList.add('hidden');
                    }
                    
                    // Populate Pinnacle readings
                    document.getElementById('pinnacle-reading-title').textContent = numerologyData.pinnacles_title || "Your Pinnacles of Glory";
                    const pinnacleContainer = document.getElementById('pinnacle-readings-container');
                    pinnacleContainer.innerHTML = '';
                    numerologyData.pinnacles.forEach((pinnacle, index) => {
                        const card = document.createElement('div');
                        card.className = 'bg-white p-4 rounded-xl shadow-sm border-l-4 border-yellow-500';
                        card.innerHTML = `
                            <h4 class="text-xl font-bold text-yellow-700">Pinnacle ${index + 1}: ${pinnacle.pinnacle_number}</h4>
                            <p class="text-sm text-gray-500 mb-2">Age Range: ${pinnacle.age_range}</p>
                            <p class="font-semibold text-yellow-600 mb-2">${pinnacle.pinnacle_title}</p>
                            <p class="text-gray-600 text-sm">${pinnacle.description}</p>
                        `;
                        pinnacleContainer.appendChild(card);
                    });

                    // Populate Challenge readings
                    document.getElementById('challenge-reading-intro').textContent = numerologyData.challenges_intro || "Your challenge numbers reveal key areas for personal growth and development.";
                    const challengeContainer = document.getElementById('challenge-readings-container');
                    challengeContainer.innerHTML = '';
                    numerologyData.challenges.forEach((challenge, index) => {
                        const card = document.createElement('div');
                        card.className = 'bg-white p-4 rounded-xl shadow-sm border-l-4 border-red-500';
                        card.innerHTML = `
                            <h4 class="text-xl font-bold text-red-700">Challenge ${index + 1}: ${challenge.challenge_number}</h4>
                            <p class="text-gray-600 text-sm mt-2">${challenge.description}</p>
                        `;
                        challengeContainer.appendChild(card);
                    });

                    // Populate Personal Cycle readings
                    document.getElementById('yearly-number').textContent = userCycles.yearly;
                    document.getElementById('yearly-description').textContent = numerologyData.yearly_description;
                    document.getElementById('monthly-number').textContent = userCycles.monthly;
                    document.getElementById('monthly-description').textContent = numerologyData.monthly_description;
                    document.getElementById('daily-number').textContent = userCycles.daily;
                    document.getElementById('daily-description').textContent = numerologyData.daily_description;

                    // Attach listener for TTS
                    document.getElementById('listen-btn').onclick = () => {
                         let fullReadingText = `
                            ${numerologyData.main_reading_title}.
                            Your core numbers: Life Path is ${userLifePath.number}, Expression is ${userExpression.number}, and Soul Urge is ${userSoulUrge.number}.
                            ${numerologyData.core_number_description}.
                            ${hasPartner ? `${numerologyData.compatibility.title}. ${numerologyData.compatibility.description}.` : ''}
                            Your personal cycles: Your personal year is ${userCycles.yearly}. ${numerologyData.yearly_description}. Your personal month is ${userCycles.monthly}. ${numerologyData.monthly_description}. Your personal day is ${userCycles.daily}. ${numerologyData.daily_description}.
                            Your Pinnacles of Glory: ${numerologyData.pinnacles.map((p, i) => `Pinnacle ${i + 1} is ${p.pinnacle_number} for the ages of ${p.age_range}. ${p.pinnacle_title}: ${p.description}.`).join(' ')}
                            Your Challenge Numbers: ${numerologyData.challenges_intro}. ${numerologyData.challenges.map((c, i) => `Challenge ${i + 1} is ${c.challenge_number}. ${c.description}.`).join(' ')}
                        `;
                         playAudio(fullReadingText);
                    };

                    loading.classList.add('hidden');
                    resultDiv.classList.remove('hidden');

                } else {
                    throw new Error("Failed to get a valid response from the API.");
                }

            } catch (error) {
                console.error("Error fetching numerology reading:", error);
                loading.classList.add('hidden');
                form.classList.remove('hidden');
                showError("Oops! Something went wrong. Please check your input and try again.");
            }
        }
        
        // Event listener for the "New Reading" button
        document.getElementById('reset-btn').addEventListener('click', () => {
            document.getElementById('numerology-form').classList.remove('hidden');
            document.getElementById('result').classList.add('hidden');
            document.getElementById('name').value = '';
            document.getElementById('dob').value = '';
            document.getElementById('partner-name').value = '';
            document.getElementById('partner-dob').value = '';
            const audioPlayer = document.getElementById('audio-player');
            const audioContainer = document.getElementById('audio-container');
            audioPlayer.pause();
            audioPlayer.src = '';
            audioContainer.classList.add('hidden');
        });

        // Event listener for the main numerology reading
        document.getElementById('numerology-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const name = document.getElementById('name').value;
            const dob = document.getElementById('dob').value;
            const partnerName = document.getElementById('partner-name').value;
            const partnerDob = document.getElementById('partner-dob').value;
            
            if (!name || !dob) {
                showError("Please enter your full name and date of birth to get a reading.");
                return;
            }
            getComprehensiveReading(name, dob, partnerName, partnerDob);
        });
    </script>
</body>
</html>
