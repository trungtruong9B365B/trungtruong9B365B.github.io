<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tử Vi Trọn Đời</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f0f2f5;
        }
        .la-so-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            grid-template-rows: repeat(4, 1fr);
            border: 2px solid #4a5568;
            aspect-ratio: 1/1;
            max-width: 600px;
            margin: auto;
        }
        .cung {
            border: 1px solid #cbd5e0;
            padding: 4px;
            font-size: 0.7rem;
            line-height: 1.2;
            position: relative;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
        }
        .cung-title {
            font-weight: 600;
            color: #2d3748;
            text-align: center;
            font-size: 0.75rem;
        }
        .cung-content {
            flex-grow: 1;
        }
        .star-main { color: #c53030; font-weight: 600; }
        .star-good { color: #2f855a; }
        .star-bad { color: #c53030; }
        .cung-bottom {
            font-size: 0.65rem;
            text-align: center;
            color: #718096;
        }
        .cung-corner { background-color: #e2e8f0; }
        .triet {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 3rem;
            font-weight: bold;
            color: rgba(226, 72, 72, 0.5);
            z-index: 10;
        }
        .tuan {
             position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 3rem;
            font-weight: bold;
            color: rgba(74, 85, 104, 0.5);
            z-index: 10;
        }

        /* Accordion styles */
        .accordion-item {
            border-bottom: 1px solid #e2e8f0;
        }
        .accordion-header {
            cursor: pointer;
            padding: 1rem;
            background-color: #f7fafc;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .accordion-content {
            padding: 1rem;
            background-color: #ffffff;
            display: none;
        }
        .accordion-content.active {
            display: block;
        }
        .accordion-arrow {
            transition: transform 0.3s ease;
        }
        .accordion-header.active .accordion-arrow {
            transform: rotate(180deg);
        }
    </style>
</head>
<body class="bg-gray-100 text-gray-800 p-4 md:p-8">

    <div class="max-w-7xl mx-auto bg-white rounded-2xl shadow-lg p-6 md:p-8">
        <header class="text-center mb-8">
            <h1 class="text-3xl md:text-4xl font-bold text-gray-800">Tử Vi Trọn Đời</h1>
            <p class="text-gray-500 mt-2">Luận giải lá số dựa trên thông tin ngày sinh của bạn</p>
        </header>

        <!-- Input Form -->
        <div id="input-section" class="mb-8 p-6 bg-slate-50 rounded-xl border border-slate-200">
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
                <div>
                    <label for="name" class="block text-sm font-medium text-gray-700">Họ và Tên</label>
                    <input type="text" id="name" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm" value="Trương Trần Trung">
                </div>
                <div>
                    <label for="dob" class="block text-sm font-medium text-gray-700">Ngày Sinh (Dương Lịch)</label>
                    <input type="date" id="dob" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm" value="1995-10-17">
                </div>
                <div>
                    <label for="tob" class="block text-sm font-medium text-gray-700">Giờ Sinh</label>
                    <input type="time" id="tob" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm" value="05:20">
                </div>
                <div class="flex items-end">
                    <button id="generate-btn" class="w-full bg-indigo-600 text-white font-semibold py-2 px-4 rounded-md hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 transition duration-150 ease-in-out">
                        Luận Giải Lá Số
                    </button>
                </div>
            </div>
        </div>

        <!-- Results Section -->
        <div id="results-section" class="hidden">
            
            <!-- Loading Spinner -->
            <div id="loading" class="text-center p-8">
                <svg class="animate-spin h-10 w-10 text-indigo-600 mx-auto" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                    <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                    <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                </svg>
                <p class="mt-4 text-lg font-medium text-gray-600">Đang an sao và luận giải lá số... Vui lòng chờ trong giây lát.</p>
            </div>

            <!-- Content Area -->
            <div id="content-wrapper" class="hidden">
                 <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                    <!-- Left Column: Basic Info & Chart -->
                    <div class="lg:col-span-1 space-y-6">
                        <div class="bg-gray-50 p-4 rounded-lg border">
                            <h2 class="text-xl font-bold mb-4 text-center text-gray-700">Thông Tin Cơ Bản</h2>
                            <div id="basic-info" class="space-y-2 text-sm">
                                <!-- Basic info will be populated here -->
                            </div>
                        </div>
                        <div class="bg-gray-50 p-4 rounded-lg border">
                             <h2 class="text-xl font-bold mb-4 text-center text-gray-700">Lá Số Tử Vi</h2>
                             <div id="la-so-chart" class="la-so-grid">
                                <!-- La So Chart will be populated here -->
                             </div>
                        </div>
                    </div>

                    <!-- Right Column: Interpretations -->
                    <div class="lg:col-span-2">
                        <div class="bg-gray-50 p-4 rounded-lg border">
                            <h2 class="text-xl font-bold mb-4 text-center text-gray-700">Luận Giải Chi Tiết</h2>
                            <div id="interpretations" class="space-y-2">
                                <!-- Accordion for interpretations will be populated here -->
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // --- DOM ELEMENTS ---
        const generateBtn = document.getElementById('generate-btn');
        const inputSection = document.getElementById('input-section');
        const resultsSection = document.getElementById('results-section');
        const loadingSpinner = document.getElementById('loading');
        const contentWrapper = document.getElementById('content-wrapper');
        const basicInfoDiv = document.getElementById('basic-info');
        const laSoChartDiv = document.getElementById('la-so-chart');
        const interpretationsDiv = document.getElementById('interpretations');

        // --- DATA (Based on the provided document) ---
        // In a real application, this data would be calculated by a complex astrological engine.
        // Here, we are using it as a static template to demonstrate the structure and AI-powered interpretation.
        const horoscopeData = {
            basicInfo: {
                "Họ Tên": "Trương Trần Trung",
                "Năm xem": "2021 (Tân Sửu) - 27 Tuổi (Âm Lịch)",
                "Ngày Sinh": "17/10/1995 Lúc: 05h20",
                "Tuổi": "ẤT HỢI",
                "Tháng": "ẤT DẬU (08 - AL)",
                "Ngày": "TÂN TỴ (24 - AL)",
                "Giờ": "TÂN MÃO",
                "Âm Dương": "Âm Nam - Nghịch lý",
                "Cục": "Mộc Tam Cục",
                "Mệnh": "Sơn Đầu Hỏa",
                "Chủ Mệnh": "CỰ MÔN",
                "Chủ Thân": "THIÊN CƠ",
                "Thân cư": "Thiên Di",
                "Cách cục": "NHẬT LỆ TRUNG THIÊN. KIM XÁN QUANG HUY",
            },
            palaces: [
                { name: "MỆNH", position: 3, stars: "Thái Dương (M)", modifier: "TRIỆT" },
                { name: "PHỤ MẪU", position: 9, stars: "Thiên Phủ (Đ)" },
                { name: "PHÚC ĐỨC", position: 10, stars: "Thái Âm (V), Thiên Cơ (V)", modifier: "TUẦN" },
                { name: "ĐIỀN TRẠCH", position: 11, stars: "Tử Vi (B), Tham Lang (H)", modifier: "TUẦN" },
                { name: "QUAN LỘC", position: 12, stars: "Cự Môn (H)" },
                { name: "NÔ BỘC", position: 1, stars: "Thiên Tướng (Đ)" },
                { name: "THIÊN DI", position: 2, stars: "Thiên Lương (V)" },
                { name: "TẬT ÁCH", position: 4, stars: "Liêm Trinh (Đ), Thất Sát (Đ)" },
                { name: "TÀI BẠCH", position: 5, stars: "Vô Chính Diệu" },
                { name: "TỬ TỨC", position: 6, stars: "Vô Chính Diệu" },
                { name: "PHU THÊ", position: 7, stars: "Thiên Đồng (H)" },
                { name: "HUYNH ĐỆ", position: 8, stars: "Vũ Khúc (H), Phá Quân (H)" },
            ],
            chartGrid: [
                { pos: 8, name: 'HUYNH ĐỆ', stars: 'Vũ Khúc(H)<br>Phá Quân (H)', bottom: 'Tuyệt' },
                { pos: 9, name: 'PHỤ MẪU', stars: 'Thiên Phủ(Đ)', bottom: 'Thai' },
                { pos: 10, name: 'PHÚC ĐỨC', stars: 'Thái Âm(V)<br>Thiên Cơ(V)', bottom: 'Dưỡng', modifier: 'TUẦN' },
                { pos: 11, name: 'ĐIỀN TRẠCH', stars: 'Tử Vi(B)<br>Tham Lang(H)', bottom: 'Tràng Sinh', modifier: 'TUẦN' },
                { pos: 7, name: 'PHU THÊ', stars: 'Thiên Đồng(H)', bottom: 'Mộ' },
                { pos: 0, name: 'LÁ SỐ TỬ VI', isCenter: true },
                { pos: 0, name: '', isCenter: true },
                { pos: 12, name: 'QUAN LỘC', stars: 'Cự Môn(H)', bottom: 'L.Vượng' },
                { pos: 6, name: 'TỬ TỨC', stars: 'Vô Chính Diệu', bottom: 'Bệnh' },
                { pos: 0, name: '', isCenter: true },
                { pos: 0, name: '', isCenter: true },
                { pos: 1, name: 'NÔ BỘC', stars: 'Thiên Tướng(Đ)', bottom: 'Đ.Vượng' },
                { pos: 5, name: 'TÀI BẠCH', stars: 'Vô Chính Diệu', bottom: 'Suy' },
                { pos: 4, name: 'TẬT ÁCH', stars: 'Liêm Trinh(Đ)<br>Thất Sát(Đ)', bottom: 'L.Nô' },
                { pos: 3, name: 'MỆNH', stars: 'Thái Dương(M)', bottom: 'Triệt', modifier: 'TRIỆT' },
                { pos: 2, name: 'THIÊN DI', stars: 'Thiên Lương(V)', bottom: 'Mộc Dục' },
            ]
        };

        // --- EVENT LISTENERS ---
        generateBtn.addEventListener('click', handleGeneration);

        // --- FUNCTIONS ---

        /**
         * Main handler to start the horoscope generation process.
         */
        async function handleGeneration() {
            // 1. Show loading state
            resultsSection.classList.remove('hidden');
            loadingSpinner.classList.remove('hidden');
            contentWrapper.classList.add('hidden');
            interpretationsDiv.innerHTML = ''; // Clear previous results

            // 2. Populate static info
            populateBasicInfo();
            populateLaSoChart();

            // 3. Generate interpretations using AI
            try {
                const interpretationPromises = horoscopeData.palaces.map(palace => 
                    getInterpretation(palace.name, palace.stars, palace.modifier)
                );
                
                const interpretations = await Promise.all(interpretationPromises);

                interpretations.forEach((text, index) => {
                    const palace = horoscopeData.palaces[index];
                    createAccordionItem(palace.name, palace.stars, text, index === 0);
                });

                // Add summary sections
                const summaryTopics = [
                    { title: "Vận Hạn (Các Giai Đoạn Cuộc Đời)", promptDetail: "luận giải tổng quan về các đại vận 10 năm, từ 23-32 tuổi, 33-42 tuổi, 43-52 tuổi, và 53-62 tuổi" },
                    { title: "Tổng Kết và Lời Khuyên", promptDetail: "đưa ra một bản tóm tắt tổng kết và những lời khuyên quan trọng nhất cho lá số này" }
                ];

                for (const topic of summaryTopics) {
                    const summaryText = await getInterpretation(topic.title, `Dựa trên toàn bộ lá số, ${topic.promptDetail}.`);
                    createAccordionItem(topic.title, '', summaryText, false);
                }

            } catch (error) {
                console.error("Error generating interpretations:", error);
                interpretationsDiv.innerHTML = `<div class="p-4 bg-red-100 text-red-700 rounded-md">Đã xảy ra lỗi khi luận giải. Vui lòng thử lại. Lỗi: ${error.message}</div>`;
            }

            // 4. Hide loading and show content
            loadingSpinner.classList.add('hidden');
            contentWrapper.classList.remove('hidden');
        }

        /**
         * Fetches interpretation for a palace from the Gemini API.
         * Implements exponential backoff for retries.
         */
        async function getInterpretation(palaceName, stars, modifier = '') {
            const prompt = `Với vai trò là một chuyên gia Tử Vi, hãy luận giải chi tiết về ${palaceName} trong một lá số Tử Vi. Cung này có các chính tinh là ${stars}. ${modifier ? `Cung này bị ảnh hưởng bởi sao ${modifier}.` : ''} Hãy phân tích ý nghĩa, những điểm tốt, xấu và đưa ra lời khuyên. Viết bằng tiếng Việt, văn phong rõ ràng, sâu sắc như trong tài liệu tham khảo.`;
            
            let chatHistory = [{ role: "user", parts: [{ text: prompt }] }];
            const payload = { contents: chatHistory };
            const apiKey = ""; // API key will be provided by the environment
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`;
            
            let delay = 1000; // Start with 1 second delay
            for (let i = 0; i < 5; i++) { // Retry up to 5 times
                try {
                    const response = await fetch(apiUrl, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });

                    if (!response.ok) {
                        throw new Error(`API request failed with status ${response.status}`);
                    }

                    const result = await response.json();
                    
                    if (result.candidates && result.candidates.length > 0 &&
                        result.candidates[0].content && result.candidates[0].content.parts &&
                        result.candidates[0].content.parts.length > 0) {
                        // Replace markdown with HTML tags for simple formatting
                        let text = result.candidates[0].content.parts[0].text;
                        text = text.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>'); // Bold
                        text = text.replace(/\n/g, '<br>'); // Newlines
                        return text;
                    } else {
                         throw new Error("Unexpected API response structure or content missing.");
                    }
                } catch (error) {
                    console.warn(`Attempt ${i + 1} failed for ${palaceName}. Retrying in ${delay}ms...`);
                    if (i < 4) {
                        await new Promise(resolve => setTimeout(resolve, delay));
                        delay *= 2; // Exponential backoff
                    } else {
                        console.error(`Failed to get interpretation for ${palaceName} after multiple retries.`, error);
                        return `<p class="text-red-500">Không thể tải được luận giải cho cung này. Vui lòng thử lại sau.</p>`;
                    }
                }
            }
        }

        /**
         * Populates the basic information section.
         */
        function populateBasicInfo() {
            basicInfoDiv.innerHTML = Object.entries(horoscopeData.basicInfo)
                .map(([key, value]) => `
                    <div class="flex justify-between">
                        <span class="font-semibold text-gray-600">${key}:</span>
                        <span class="text-right">${value}</span>
                    </div>
                `).join('');
        }

        /**
         * Creates and populates the 12-palace grid chart.
         */
        function populateLaSoChart() {
            laSoChartDiv.innerHTML = ''; // Clear previous chart
            const centerContent = `
                <div class="text-center text-xs">
                    <p><strong>Họ tên:</strong> ${horoscopeData.basicInfo['Họ Tên']}</p>
                    <p><strong>Năm sinh:</strong> ${horoscopeData.basicInfo['Tuổi']}</p>
                    <p><strong>Mệnh:</strong> ${horoscopeData.basicInfo['Mệnh']}</p>
                    <p><strong>Cục:</strong> ${horoscopeData.basicInfo['Cục']}</p>
                    <p><strong>Thân cư:</strong> ${horoscopeData.basicInfo['Thân cư']}</p>
                </div>
            `;

            let gridItems = '';
            let chartIndex = 0;
            for (let i = 0; i < 16; i++) {
                // These are the center cells of the 4x4 grid
                if ([5, 6, 9, 10].includes(i)) {
                    if (i === 5) { // Put main info in the first center cell
                        gridItems += `<div class="cung flex items-center justify-center p-1">${centerContent}</div>`;
                    } else {
                        gridItems += `<div class="cung cung-corner"></div>`;
                    }
                } else {
                    const cell = horoscopeData.chartGrid[chartIndex];
                    if (cell) {
                        let modifierHtml = '';
                        if (cell.modifier === 'TRIỆT') {
                            modifierHtml = '<div class="triet">Triệt</div>';
                        } else if (cell.modifier === 'TUẦN') {
                            modifierHtml = '<div class="tuan">Tuần</div>';
                        }

                        gridItems += `
                            <div class="cung relative">
                                ${modifierHtml}
                                <div class="cung-title">${cell.name}</div>
                                <div class="cung-content star-main">${cell.stars}</div>
                                <div class="cung-bottom">${cell.bottom}</div>
                            </div>
                        `;
                    }
                    chartIndex++;
                }
            }
            laSoChartDiv.innerHTML = gridItems;
        }

        /**
         * Creates an accordion item for an interpretation.
         */
        function createAccordionItem(title, stars, content, isOpen = false) {
            const item = document.createElement('div');
            item.className = 'accordion-item';
            
            const headerId = `header-${title.replace(/\s+/g, '-')}`;
            const contentId = `content-${title.replace(/\s+/g, '-')}`;

            item.innerHTML = `
                <div id="${headerId}" class="accordion-header ${isOpen ? 'active' : ''}" role="button" aria-expanded="${isOpen}" aria-controls="${contentId}">
                    <div>
                        <h3 class="font-semibold text-lg text-indigo-700">${title}</h3>
                        <p class="text-sm text-gray-500">${stars}</p>
                    </div>
                    <svg class="accordion-arrow w-6 h-6 text-gray-500" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
                </div>
                <div id="${contentId}" class="accordion-content prose prose-sm max-w-none ${isOpen ? 'active' : ''}" aria-labelledby="${headerId}">
                    ${content}
                </div>
            `;
            interpretationsDiv.appendChild(item);

            // Add click listener to the header
            const header = item.querySelector('.accordion-header');
            header.addEventListener('click', () => {
                const content = item.querySelector('.accordion-content');
                header.classList.toggle('active');
                content.classList.toggle('active');
                const isExpanded = header.getAttribute('aria-expanded') === 'true';
                header.setAttribute('aria-expanded', !isExpanded);
            });
        }

    </script>
</body>
</html>
